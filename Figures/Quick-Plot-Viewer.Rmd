---
title: "Quick Plot Viewer"
author: "Christelinda Laureijs"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    css: "../Templates/my-CSS-theme.css"
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
  pdf_document:
    toc: false
    latex_engine: xelatex
    fig_caption: true
    includes:
      in_header: ../Templates/MtA-Thesis-Preamble.tex
fontsize: 12pt
geometry:
- margin = 1in
- bindingoffset = 0mm
linestretch: 1.5
classoption: twoside
indent: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  comment = "",
  message = F,
  warning = F,
  fig.width = 14
)

if (knitr::is_latex_output()) {
  knitr::opts_chunk$set(dev = "cairo_pdf")
} else
  (knitr::opts_chunk$set(dev = "png", dpi = 300)
  )
```

```{r load-libraries, include=F}
library(here)
library(ggplot2)
library(dplyr)
library(extrafont) # Required for custom fonts in plots
library(ggtext) # Required for formatting plot text (e.g. coloured text in title)
library(glue) # Required for easy mixing of variables and text
library(grid) # Required for rasterGrob function to have a background image on a plot
library(gridExtra) # Required for more rasterGrob functions on cell coordinates plot
library(ggforce) # Required for sina plots
library(patchwork) # Required for multi-plot layout
library(rstatix) # Required for t-tests within tidyverse framework
library(tidyr)
library(broom)
library(lazyWeave) # Provides pvalString
library(knitr)
library(ggsignif) # Required for significance stars and brackets on plots
library(abftools)

# This script file contains my functions for pruning the data and creating plots of P1 vs. Time
# I sourced these to an external file to reduce the length of my code

# Set local = knitr::knit_global() to ensure that the script uses THIS document's directory,
# not the Scripts/ folder

source(here("Scripts", "Functions.R"), local = knitr::knit_global())
```

```{r set-plot-options}
# ---------- Set plot options --------------------------------------------------------------------------------
# Set save_choice to "yes" if you want to save plots (! this will increase the run time; generally only run this after adding new data)
# Saved plots will automatically go to Figures/Output-... folders depending on what type they are
# E.g. Raw plots of the first evoked current over time (P1 vs. Time) will go into Figures/Output-individual-plots

save_choice <- "yes"

# Set colours here only for consistency

line_col <- "#333333" # Sets colour of x and y-axes
my_colours <-
  c("#6600cc",
    "#0093fb",
    "#55b323",
    "#ffe70f",
    "#e86c00",
    "#333333")
my_colours_pale <-
  c("#b080e0",
    "#5cb9fa",
    "#92d46e",
    "#ebdf05",
    "#f58c31",
    "#b1b1b1")

# Required for better contrast between the sexes in summary plots
# Do NOT use these for any of the raw P1 vs. Time plots because they are too pale and/or too dark
my_colours_very_dark <-
  c("#4d0299",
    "#026bb5",
    "#398511",
    "#a69502",
    "#994700",
    "#000000")
my_colours_very_pale <-
  c("#d6b8f5",
    "#8fd0ff",
    "#aee691",
    "#ebdf05",
    "#ffc38f",
    "#dcdcdc")

# Set default colours and point sizes for action potential summary plots
mean_point_colour <- "#000000"
control_group_colour <- "#727a85"
insulin_group_colour <- "#0093fb"

mean_point_size <- 0.5
geom_sina_size <- 3
geom_signif_text_size <- 8

AP_trace_size <- 0.8
scale_bar_shift_y <- 5
scale_bar_shift_x <- 30

# These sizes work better for the multi-plot figure in the PDF output
if (knitr::is_latex_output()) {
  geom_sina_size <- 2
  geom_signif_text_size <- 4
  AP_trace_size <- 0.6
  scale_bar_shift_y <- 13
  scale_bar_shift_x <- 200
}


if (knitr::is_html_output()) {
  geom_sina_size <- 2
  geom_signif_text_size <- 4
  AP_trace_size <- 0.6
  scale_bar_shift_y <- 13
  scale_bar_shift_x <- 200
}


# Custom fonts may cause issues depending on what fonts you have in your system
# Troubleshooting steps:
# Try changing the font to one that you have on your computer
# If it does not work, you could always delete 'family = plot_font_family' in the ggplot theme set below
plot_font_family <- "Segoe UI"
plot_light_font_family <- "Segoe UI Light"
significance_stars_font <- plot_font_family

# A consistent y-axis enables comparison across multiple experiments, treatments, etc.
# This is not applied to the raw plots of eEPSCs vs. time for individual cells
# If you change this from 175, make sure to regenerate all summary plots so that you can compare across the same y-axis.

y_axis_limit <- 175
PPR_y_min <- 0
PPR_y_max <- 5
```

```{r set-ggplot2-theme}
# ----------- Set ggplot theme ----------------------------------------------------------------------------------
# Formatting changes like increasing font size & removing gray background
# Requires the extrafont() package (loaded in the load-libraries chunk) for custom font.

modified_theme_classic <- theme_classic() +
  theme(
    text = element_text(family = plot_font_family),
    plot.title = element_text(
      color = "black",
      size = 20,
      family = plot_font_family,
      # face = "plain",
      margin = margin(b = 25),
      hjust = 0.5
    ),
    plot.margin = margin(25, 25, 25, 25),
    plot.caption = element_text(
      hjust = 0,
      family = plot_font_family,
      size = 12
    ),
    plot.caption.position = "plot",
    axis.text = element_text(size = 12,
                             color = "black"),
    axis.title = element_text(size = 16,
                              face = "bold"),
    axis.title.y = element_text(
      margin = margin(r = 25),
      angle = 90,
      vjust = 0.5
    ),
    axis.title.x = element_text(margin = margin(b = 25, t = 20)),
    axis.ticks = element_blank(),
    strip.background = element_rect(color = NA, fill = NA),
    strip.text = element_text(size = 20)
  )

theme_set(modified_theme_classic)

modified_facet_theme <- modified_theme_classic +
  theme(
    legend.position = "none",
    axis.line.x = element_line(color = "gray"),
    axis.line.y = element_line(color = "gray"),
    panel.spacing = unit(2, "lines"),
    plot.title = element_text(family = plot_light_font_family,
                              size = 40),
    plot.subtitle = element_text(
      size = 20,
      hjust = 0.5,
      margin = margin(b = 50)
    )
  )
```

```{r load-RDS-files}
raw_df <- readRDS(here("Data/Output-Data-from-R/raw_df.RDS"))

pruned_df_individual_cells <-
  readRDS(here("Data/Output-Data-from-R/pruned_df_individual_cells.RDS"))

t_test_eEPSCs <-
  readRDS(here("Data/Output-Data-from-R/t_test_eEPSCs.RDS"))

pruned_df <- readRDS(here("Data/Output-Data-from-R/pruned_df.RDS"))
```


```{r get-number-of-rows}
nrows <- raw_df %>%
  group_by(Treatment, Sex, Category) %>%
  summarize(n_cells = length(unique(Letter))) %>%
  mutate(
    nrows = plyr::round_any(n_cells, 3, ceiling) / 3,
    plot_height = case_when(nrows == 1 ~ 7,
                            nrows == 2 ~ 10,
                            T ~ nrows * 4)
  )
```


<!-- plot tester -->

<!-- AO or CO could be an option -->
<!-- AZ + BN both look nice, but there is little difference between conditions -->
<!-- I chose CO because the visual difference between treatments was clearer. -->



```{r quick-plot-ap-traces, fig.width = 12, fig.height = 8, eval=F}
# The recording was digitized at 10 kHz
# Therefore 1 ms = 10 time units in the recording

scale_bar_x_in_recording_time_units <- 500
scale_bar_y_in_mV <- 20
scale_bar_start_x <- 7000
scale_bar_start_y <- 20

ap_trace_control <-
  make_AP_trace_plot(file_ID = 23821007,
                     sweep = "epi10",
                     trace_color = control_group_colour) +
  annotate(
    "segment",
    x = scale_bar_start_x,
    xend = scale_bar_start_x + scale_bar_x_in_recording_time_units,
    y = scale_bar_start_y,
    yend = scale_bar_start_y,
    lwd = 0.4
  ) +
  annotate(
    "segment",
    x = scale_bar_start_x,
    xend = scale_bar_start_x,
    y = scale_bar_start_y-0.49,
    yend = scale_bar_start_y + scale_bar_y_in_mV,
    lwd = 0.4
  ) +
  annotate(
    "text",
    x = scale_bar_start_x - scale_bar_shift_x,
    y = scale_bar_start_y + 10,
    label = paste0(scale_bar_y_in_mV, " mV"),
    hjust = 1,
    family = plot_font_family
  ) +
  annotate(
    "text",
    x = scale_bar_start_x + 1/2*(scale_bar_x_in_recording_time_units),
    y = scale_bar_start_y - scale_bar_shift_y,
    
    # Recall that 1 recording time unit = 0.1 ms
    # because it was filtered at 10 kHz
    label = paste0(scale_bar_x_in_recording_time_units/10, " ms"),
    hjust = 0.5,
    family = plot_font_family
  )

ap_trace_insulin <-
  make_AP_trace_plot(file_ID = 23821015,
                     sweep = "epi10",
                     trace_color = insulin_group_colour)

dual_plot <- ap_trace_control / ap_trace_insulin

dual_plot

if (save_choice == "yes") {
  ggsave(
    plot = dual_plot,
    path = here("Figures", "Output-summary-plots"),
    file = "AP-step-10-representative-traces.png",
    width = 7,
    height = 5,
    units = "in",
    dpi = 300
  )
}
```


```{r add-representative-eEPSC-current, eval=T}
# Add representative traces
AV_representative_trace <-
  png::readPNG(here(
    "Figures/Representative-Traces/Representative-Trace-Cell-AV.png"
  ))

AV_representative_trace <- rasterGrob(AV_representative_trace)
```



```{r plot-tester, fig.width = 7, fig.height = 7, eval=F}
cell <- "AV"
raw_df %>%
  filter(Letter == cell) %>%
  filter(Time <= 25) %>%
  {
    ggplot(., aes(x = Time, y = P1)) +
      geom_point(size = 1.5) +
      geom_hline(aes(yintercept = baseline_mean), linetype = "dashed") +
      labs(title = glue("Cell {cell}"))
  } +
  annotation_custom(
    AV_representative_trace,
    xmin = 10,
    ymin = 60,
    ymax = 120
  )
```

# eEPSCs after Adding Insulin

## Control

```{r pruned-summary-plot-none, fig.width = 8, fig.height = 5, out.width = "100%"}
make_pruned_summary_plots(
  category = 2,
  treatment = "Control",
  data = pruned_df,
  color_choice = 1
) +
  annotation_custom(
    AV_representative_trace,
    xmin = 1,
    xmax = 8,
    ymin = 0,
    ymax = 40
  )
```

```{r get-one-sex-fasting-plots}
presentation_plot_fasting_male <-
  make_presentation_plots_one_sex(
    sex = "Male",
    point_shape = 16,
    point_color = my_colours_very_dark[3],
    category = 2,
    treatment = "Fasting",
    data = pruned_df,
    color_choice = 3
  ) +
  theme(axis.title = element_text(face = "plain"),
        axis.title.y = element_text(angle = 90))

presentation_plot_fasting_male

ggsave(
  presentation_plot_fasting_male,
  path = here("Figures/Output-summary-plots/One-sex-plots"),
  file = "Presentation-Plot-Fasting-MALES.png",
  width = 12,
  height = 7,
  units = "in",
  dpi = 300,
  scaling = 1.5
)


presentation_plot_fasting_female <-
  make_presentation_plots_one_sex(
    sex = "Female",
    point_shape = 15,
    point_color = my_colours_very_pale[3],
    category = 2,
    treatment = "Fasting",
    data = pruned_df,
    color_choice = 3
  ) +
  theme(axis.title = element_text(face = "plain"),
        axis.title.y = element_text(angle = 90))

presentation_plot_fasting_female

ggsave(
  presentation_plot_fasting_female,
  path = here("Figures/Output-summary-plots/One-sex-plots"),
  file = "Presentation-Plot-Fasting-FEMALES.png",
  width = 12,
  height = 7,
  units = "in",
  dpi = 300,
  scaling = 1.5
)



```



### Males {.tabset}

#### Raw

```{r raw-none-male}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Control",
  sex = "Male",
  category = 2,
  color_choice = 1
)
```

#### Pruned

```{r pruned-none-male}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_pruned_facet_plot(
  pruned_df_individual_cells,
  treatment = "Control",
  sex = "Male",
  category = 2,
  color_choice = 1
)
```

#### PPR

```{r ppr-none-male}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Control",
  sex = "Male",
  category = 2,
  y_var = PPR,
  color_choice = 1
) +
  coord_cartesian(ylim = c(PPR_y_min, PPR_y_max))
```

### Females {.tabset}

#### Raw

```{r raw-none-female}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Control",
  sex = "Female",
  category = 2,
  color_choice = 1
)
```

#### Pruned

```{r pruned-none-female}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "Control",
  sex = "Female",
  category = 2,
  color_choice = 1
)
```

#### PPR

```{r ppr-none-female}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Control",
  sex = "Female",
  category = 2,
  y_var = PPR,
  color_choice = 1
) +
  coord_cartesian(ylim = c(PPR_y_min, PPR_y_max))
```


## HNMPA

```{r HNMPA-summary, fig.dim = c(8,5)}
make_pruned_summary_plots(
  data = pruned_df,
  category = 2,
  treatment = "HNMPA",
  color_choice = 5
)
```

### Males {.tabset}

#### Raw

```{r raw-HNMPA-male}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "HNMPA",
  sex = "Male",
  category = 2,
  color_choice = 5
)
```

#### Pruned

```{r pruned-HNMPA-male}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "HNMPA",
  sex = "Male",
  category = 2,
  color_choice = 5
)
```

#### PPR

```{r ppr-HNMPA-male}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "HNMPA",
  sex = "Male",
  category = 2,
  y_var = PPR,
  color_choice = 5
) +
  coord_cartesian(ylim = c(PPR_y_min, PPR_y_max))
```


### Females {.tabset}

#### Raw

```{r raw-HNMPA-female}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "HNMPA",
  sex = "Female",
  category = 2,
  color_choice = 5
)
```

#### Pruned

```{r pruned-HNMPA-female}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "HNMPA",
  sex = "Female",
  category = 2,
  color_choice = 5
)
```

#### PPR

```{r ppr-HNMPA-female}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "HNMPA",
  sex = "Female",
  category = 2,
  y_var = PPR,
  color_choice = 5
) +
  coord_cartesian(ylim = c(PPR_y_min, PPR_y_max))
```

## Fasting

```{r fasting-summary, fig.dim = c(8,5)}
make_pruned_summary_plots(
  category = 2,
  treatment = "Fasting",
  data = pruned_df,
  color_choice = 3
)
```

```{r fasting-presentation, eval=F}
presentation_plot_fasting <-
  make_presentation_plots(2,
                          treatment = "Fasting",
                          data = pruned_df,
                          color_choice = 3) +
  labs(title = "eEPSCs decrease significantly in fasted <b style='color:#398511'>males</b> & <b style='color:#92d46e'>females</b>")

presentation_plot_fasting

if (save_choice == "yes") {
  ggsave(
    presentation_plot_fasting,
    path = here("Figures/Output-summary-plots"),
    file = "Presentation-Plot-Fasting.png",
    width = 12,
    height = 7,
    units = "in",
    dpi = 300,
    scaling = 1.5
  )
}
```



### Males {.tabset}

#### Raw

```{r raw-fasting-male}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Fasting",
  sex = "Male",
  category = 2,
  color_choice = 3
)
```

#### Pruned

```{r pruned-fasting-male}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "Fasting",
  sex = "Male",
  category = 2,
  color_choice = 3
)
```

#### PPR

```{r ppr-fasting-male}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Fasting",
  sex = "Male",
  category = 2,
  y_var = PPR,
  color_choice = 3
) +
  coord_cartesian(ylim = c(PPR_y_min, PPR_y_max))
```


### Females {.tabset}

#### Raw

```{r raw-fasting-females}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Fasting",
  sex = "Female",
  category = 2,
  color_choice = 3
)
```

#### Pruned

```{r pruned-fasting-females}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "Fasting",
  sex = "Female",
  category = 2,
  color_choice = 3
)
```

#### PPR

```{r ppr-fasting-females}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Fasting",
  sex = "Female",
  category = 2,
  y_var = PPR,
  color_choice = 3
) +
  coord_cartesian(ylim = c(PPR_y_min, PPR_y_max))
```


## PPP

```{r summary-ppp, fig.dim = c(8,5)}
make_pruned_summary_plots(
  category = 2,
  treatment = "PPP",
  data = pruned_df,
  color_choice = 2
)
```

```{r presentation-ppp, eval=F}
presentation_plot_ppp <-
  make_presentation_plots(2,
                          treatment = "PPP",
                          data = pruned_df,
                          color_choice = 2) +
  labs(title = "Current amplitudes decrease somewhat in <b style='color:#5cb9fa'>females</b> with PPP")

presentation_plot_ppp

if (save_choice == "yes") {
  ggsave(
    presentation_plot_ppp,
    path = here("Figures/Output-summary-plots"),
    file = "Presentation-Plot-PPP.png",
    width = 12,
    height = 7,
    units = "in",
    dpi = 300,
    scaling = 1.5
  )
}
```

### Females {.tabset}

#### Raw

```{r raw-ppp-female}
#| fig.height = nrows %>% filter(Treatment == "PPP" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "PPP",
  sex = "Female",
  category = 2,
  color_choice = 2
)
```

#### Pruned

```{r pruned-ppp-female}
#| fig.height = nrows %>% filter(Treatment == "PPP" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "PPP",
  sex = "Female",
  category = 2,
  color_choice = 2
)
```

#### PPR

```{r ppr-ppp-female}
#| fig.height = nrows %>% filter(Treatment == "PPP" & Sex == "Female" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "PPP",
  sex = "Female",
  category = 2,
  y_var = PPR,
  color_choice = 2
) +
  coord_cartesian(ylim = c(PPR_y_min, PPR_y_max))
```

### Males {.tabset}

#### Raw

```{r raw-ppp-Male}
#| fig.height = nrows %>% filter(Treatment == "PPP" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "PPP",
  sex = "Male",
  category = 2,
  color_choice = 2
)
```

#### Pruned

```{r pruned-ppp-Male}
#| fig.height = nrows %>% filter(Treatment == "PPP" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "PPP",
  sex = "Male",
  category = 2,
  color_choice = 2
)
```

#### PPR

```{r ppr-ppp-Male}
#| fig.height = nrows %>% filter(Treatment == "PPP" & Sex == "Male" & Category == 2) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "PPP",
  sex = "Male",
  category = 2,
  y_var = PPR,
  color_choice = 2
) +
  coord_cartesian(ylim = c(PPR_y_min, PPR_y_max))
```

```{r knitr-exit}
knitr::knit_exit()
```


# Get Presentation Plots

# Fix: Significance stars are from Category 2

# PPR post HFS Control

## None

```{r HFS-control-summary, fig.dim = c(8,5)}
make_pruned_summary_plots(
  category = 1,
  treatment = "Control",
  data = pruned_df,
  color_choice = 1
)
```

### Males {.tabset}

#### Raw

```{r raw-none-male-HFS}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Male" & Category == 1) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Control",
  sex = "Male",
  category = 1
)
```

#### Pruned

```{r pruned-none-male-HFS}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Male" & Category == 1) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "Control",
  sex = "Male",
  category = 1
)
```

### Females {.tabset}

#### Raw 

```{r raw-none-female-HFS}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Female" & Category == 1) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Control",
  sex = "Female",
  category = 1
)
```

#### Pruned

```{r pruned-none-female-HFS}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Female" & Category == 1) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "Control",
  sex = "Female",
  category = 1
)
```

## Fasting

```{r fasting-summary-HFS, fig.dim = c(8,5)}
make_pruned_summary_plots(
  category = 1,
  treatment = "Fasting",
  data = pruned_df,
  color_choice = 1
)
```

### Males {.tabset}

#### Raw

```{r}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Male" & Category == 1) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Fasting",
  sex = "Male",
  category = 1
)
```

#### Pruned

```{r}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Male" & Category == 1) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "Fasting",
  sex = "Male",
  category = 1
)
```

## L-NAME

```{r fig.dim = c(8,5)}
make_pruned_summary_plots(category = 1,
                          treatment = "L-NAME",
                          data = pruned_df,
                          color_choice = 1)
```

### Males {.tabset}

#### Raw

```{r}
#| fig.height = nrows %>% filter(Treatment == "L-NAME" & Sex == "Female" & Category == 1) %>% pull(plot_height)

make_facet_plot(
                data = raw_df,
                treatment = "L-NAME",
                sex = "Female",
                category = 1
                )
```

#### Pruned

```{r}
#| fig.height = nrows %>% filter(Treatment == "L-NAME" & Sex == "Female" & Category == 1) %>% pull(plot_height)

make_pruned_facet_plot(data = pruned_df_individual_cells,
                       treatment = "L-NAME",
                       sex = "Female",
                       category = 1)
```

# PPR post HFS with Insulin

## None

```{r fig.dim = c(8,5)}
make_pruned_summary_plots(
  category = 3,
  treatment = "Control",
  data = pruned_df,
  color_choice = 3
)
```

### Males {.tabset}

#### Raw

```{r}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Male" & Category == 3) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Control",
  sex = "Male",
  category = 3
)
```

#### Pruned

```{r}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Male" & Category == 3) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "Control",
  sex = "Male",
  category = 3
)
```

### Females {.tabset}

#### Raw

```{r}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Female" & Category == 3) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Control",
  sex = "Female",
  category = 3
)
```

#### Pruned

```{r}
#| fig.height = nrows %>% filter(Treatment == "Control" & Sex == "Female" & Category == 3) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "Control",
  sex = "Female",
  category = 3
)
```

## HNMPA

```{r fig.dim = c(8,5)}
make_pruned_summary_plots(
  category = 3,
  treatment = "HNMPA",
  data = pruned_df,
  color_choice = 3
)
```

### Males {.tabset}

#### Raw

```{r}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Male" & Category == 3) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "HNMPA",
  sex = "Male",
  category = 3
)
```

#### Pruned

```{r}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Male" & Category == 3) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "HNMPA",
  sex = "Male",
  category = 3
)
```

### Females {.tabset}

#### Raw

```{r}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Female" & Category == 3) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "HNMPA",
  sex = "Female",
  category = 3
)
```

#### Pruned

```{r}
#| fig.height = nrows %>% filter(Treatment == "HNMPA" & Sex == "Female" & Category == 3) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "HNMPA",
  sex = "Female",
  category = 3
)
```

## Fasting

```{r fig.dim = c(8,5)}
make_pruned_summary_plots(
  category = 3,
  treatment = "Fasting",
  data = pruned_df,
  color_choice = 3
)
```

### Males {.tabset}

#### Raw

```{r}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Male" & Category == 3) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "Fasting",
  sex = "Male",
  category = 3
)
```

#### Pruned

```{r}
#| fig.height = nrows %>% filter(Treatment == "Fasting" & Sex == "Male" & Category == 3) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "Fasting",
  sex = "Male",
  category = 3
)
```

## AM251

```{r fig.dim = c(8,5)}
make_pruned_summary_plots(category = 3,
                          "AM251",
                          data = pruned_df,
                          color_choice = 3)
```

### Males {.tabset}

#### Raw

```{r}
#| fig.height = nrows %>% filter(Treatment == "AM251" & Sex == "Male" & Category == 3) %>% pull(plot_height)

make_facet_plot(data = raw_df,
                "AM251",
                sex = "Male",
                category = 3)
```

#### Pruned

```{r}
#| fig.height = nrows %>% filter(Treatment == "AM251" & Sex == "Male" & Category == 3) %>% pull(plot_height)

make_pruned_facet_plot(data = pruned_df_individual_cells,
                       "AM251",
                       sex = "Male",
                       category = 3)
```

## PPP

```{r fig.dim = c(8,5)}
make_pruned_summary_plots(
  category = 3,
  treatment = "PPP",
  data = pruned_df,
  color_choice = 3
)
```

### Females {.tabset}

#### Raw

```{r}
#| fig.height = nrows %>% filter(Treatment == "PPP" & Sex == "Female" & Category == 3) %>% pull(plot_height)

make_facet_plot(
  data = raw_df,
  treatment = "PPP",
  sex = "Female",
  category = 3
)
```

#### Pruned 

```{r}
#| fig.height = nrows %>% filter(Treatment == "PPP" & Sex == "Female" & Category == 3) %>% pull(plot_height)

make_pruned_facet_plot(
  data = pruned_df_individual_cells,
  treatment = "PPP",
  sex = "Female",
  category = 3
)
```


# --------- Knit Exit --------------------------

```{r}
knitr::knit_exit()
```


# Action Potential Analysis

Change file structure and some code to reflect changes made in Thesis. Most recent Ap analysis is in Thesis.

```{r import-and-merge-AP-data}
# Import action potential csv file
ap_data <- read.csv(here("Data/Raw-CSVs/20240325-AP-Analysis.csv"), header = T)

# I removed the following cells from my dataset:
# AH, AM (Current clamp steps 'After' recording was after Insulin and high-frequency stimulation)
# FO, FP (Lost the cell before I could record 'After') 

ap_data <- ap_data %>%
  filter(! Letter %in% c("AH", "AM", "FO", "FP"))

# Add new column with frequency of APs
  # Each sweep lasts 0.5 seconds, so to get frequency in Hz, I divided the number of APs by 0.5

# Add a new column that states the current injection used at each step
  # Rename column 't_x' to 'Threshold', which is more useful

ap_data <- ap_data %>%
  mutate(
    AP_frequency = No_of_APs / 0.5,
    Latency_to_fire = Time_to_Peak - 265.4,
    Antipeak_time_relative_to_threshold = Time_of_antipeak - Time_of_Threshold,
    Current_injection = case_when(
      Sweep == 1 ~ -50,
      Sweep == 2 ~ -40,
      Sweep == 3 ~ -30,
      Sweep == 4 ~ -20,
      Sweep == 5 ~ -10,
      Sweep == 6 ~ 0,
      Sweep == 7 ~ 10,
      Sweep == 8 ~ 20,
      Sweep == 9 ~ 30,
      Sweep == 10 ~ 40,
      T ~ 50
    )
  ) %>%
  rename(Threshold = t_x)

# Import CSV with info on sex, synapses, X, Y, treatment, animal, etc.
cell_characteristics <-
  read.csv(here("Data/Plaintext-Cell-Characteristics.csv"))

# Merge datasets to get complete AP dataset
full_ap_df <-
  merge(ap_data,
        cell_characteristics,
        by = "Letter")

last_steps <- full_ap_df %>%
  select(Letter, State, Current_injection, AP_frequency, ID) %>%
  filter(Current_injection == 40)

# Create list of the order of AP parameters
# This ensures that the parameters are listed in a consistent order in the t-test and Shapiro-Wilk tables
list_of_AP_parameters <-
  c(
    "Peak_amplitude",
    "Threshold",
    "Half_width",
    "Latency_to_fire",
    "Antipeak_amplitude",
    "Antipeak_time_relative_to_threshold"
  )
```

```{r get-max-frequencies-per-step}
# Create a dataframe containing the maximum mean AP frequency at each step.
# Required for correct positioning of significance stars

max_mean_AP_frequencies <- full_ap_df %>%
  group_by(Current_injection, State) %>%
  summarize(
    mean_AP_frequency = mean(AP_frequency),
    SE = sd(AP_frequency) / sqrt(n())
  ) %>%
  group_by(Current_injection) %>%
  summarize(
    max_AP_frequency = max(mean_AP_frequency),
    max_se = max(SE)
  )
```

```{r t-test-ap-frequency}
# I saved this to a dataframe so I could later add significance asterisks to my plot through geom_text()
# "ns" is distracting in plots, so I replaced it with whitespace

t_test_current_clamp_steps <- full_ap_df %>%
  select(Letter, State, AP_frequency, Current_injection) %>%
  group_by(Current_injection) %>%
  pairwise_t_test(
    AP_frequency ~ State,
    ref.group = "Control",
    paired = T,
    p.adjust.method = "holm"
  ) %>%
  mutate(
    statistic = round(statistic, 2),
    p_string = pvalString(p),
    significance_stars = case_when(p.adj.signif == "ns" ~ "",
                             T ~ p.adj.signif)) %>%
  merge(., max_mean_AP_frequencies,
        by = "Current_injection")

t_test_current_clamp_steps %>% 
  select(c(Current_injection, statistic, df, p_string, p.adj.signif)) %>%
  kable(
    col.names = c("Current Injection", "Statistic", "DF", "p-value", ""),
    caption = "Pairwise T-Test with Holm's Correction"
  )
```


```{r create-AP-dataset-for-statistical-analysis}
# Each letter contains 10 rows (one for each sweep)
# This means that the data in columns like 'Threshold', 'Peak_amplitude', 'Time_of_peak' are repeated 10 times
# Create a dataframe for the AP sina plots that does not contain repeated rows

distinct_aps <- full_ap_df %>%
  distinct(Letter, State, .keep_all = TRUE)

# For each recording, get the difference in before vs. after values for
# Peak amplitude, latency, etc.
# Use arrange() to ensure that the states are arranged in the proper order within each letter
# These are in the form of
  # (latency_diff) = (latency_insulin) - (latency_control)
# Ungroup data to avoid issues later


# Note that there are more values for peak amplitude than the other AP parameters
# This is because some recordings did not have any action potentials
# For these recordings, I wrote "0" for peak amplitude and "NA" for the other AP parameters like half-width

distinct_aps_differences <- distinct_aps %>%
  arrange(Letter, State) %>%
  group_by(Letter) %>%
  mutate(
    Peak_amplitude_diff = Peak_amplitude - lag(Peak_amplitude),
    Latency_diff = Latency_to_fire - lag(Latency_to_fire),
    Threshold_diff = Threshold - lag(Threshold),
    Antipeak_amplitude_diff = Antipeak_amplitude - lag(Antipeak_amplitude),
    Antipeak_time_relative_to_threshold_diff = Antipeak_time_relative_to_threshold - lag(Antipeak_time_relative_to_threshold),
    Half_width_diff = Half_width - lag(Half_width)
  ) %>%
  ungroup() %>%
  drop_na(
    c(
      Peak_amplitude_diff,
      Latency_diff,
      Threshold_diff,
      Antipeak_amplitude_diff,
      Antipeak_time_relative_to_threshold_diff,
      Half_width_diff
    )
  )
```

```{r pivot-longer-AP-data}
# Pivot data to longer form
# Makes it easier to run t-tests across separate AP parameters at once through tidyr framework

wide_ap_df <- distinct_aps %>%
  pivot_longer(
    cols = c(
      "Peak_amplitude",
      "Threshold",
      "Half_width",
      "Latency_to_fire",
      "Antipeak_amplitude",
      "Antipeak_time_relative_to_threshold"
    ),
    names_to = "AP_parameter_name",
    values_to = "AP_parameter_value"
  )

wide_ap_df_differences <- distinct_aps_differences %>%
  pivot_longer(
    cols = c(
      "Peak_amplitude_diff",
      "Threshold_diff",
      "Half_width_diff",
      "Latency_diff",
      "Antipeak_amplitude_diff",
      "Antipeak_time_relative_to_threshold_diff"
    ),
    names_to = "AP_parameter_diff_name",
    values_to = "AP_parameter_diff"
  )
```


## Statistical Tests

## T-test

```{r ap-parameters-t-test}
wide_ap_df %>%
  group_by(AP_parameter_name) %>%
  t_test(
    AP_parameter_value ~ State,
    ref.group = "Control",
    paired = T
  ) %>%
  mutate(
    statistic = round(statistic, 2),
    p_original = p,
    p_string = pvalString(p),
    significance_stars = symnum(p, 
                     symbols   = c("***","**","*",""),
                     cutpoints = c(0,  .001,.01,.05, 1),
                     corr      = FALSE
                   )
  ) %>%
  arrange(match(AP_parameter_name, list_of_AP_parameters)) %>%
  select(c(AP_parameter_name, statistic, df, p_string, significance_stars)) %>%
  kable(
    col.names = c("Parameter", "Statistic", "DF", "p-value", ""),
    caption = "Paired T-Test"
  )
```

## Shapiro-Wilk Normality testing

```{r ap-parameters-shapiro-test}
wide_ap_df_differences %>%
  group_by(AP_parameter_diff_name) %>%
  shapiro_test(AP_parameter_diff) %>%
  select(!variable) %>%
  mutate(
    p_string = pvalString(p),
    p_true = p,
    statistic = round(statistic, 2),
    significance_stars = symnum(
      p,
      symbols   = c("***", "**", "*", ""),
      cutpoints = c(0,  .001, .01, .05, 1),
      corr      = FALSE
    )
  ) %>%
  select(c(
    AP_parameter_diff_name,
    statistic,
    p_string,
    significance_stars
  )) %>%
  arrange(match(
    AP_parameter_diff_name,
    c(
      "Peak_amplitude_diff",
      "Threshold_diff",
      "Half_width_diff",
      "Latency_diff",
      "Antipeak_amplitude_diff",
      "Antipeak_time_relative_to_threshold_diff"
    )
  )) %>%
  kable(col.names = c("Parameter", "Statistic", "P-value", ""),
        caption = "Shapiro-Wilk Normality Test")
```

## QQ-Plots {.tabset}

### Peak Amplitude

```{r QQ-plot-peak_amplitude, fig.width = 7, fig.height = 5}
make_qq_plot(data = distinct_aps_differences,
             parameter_title = "Peak amplitude",
             parameter = Peak_amplitude_diff)
```

### Threshold

```{r QQ-plot-threshold, fig.width = 7, fig.height = 5}
make_qq_plot(data = distinct_aps_differences,
             parameter_title = "Threshold",
             parameter = Threshold_diff)
```

### Half-Width

```{r QQ-plot-half-width, fig.width = 7, fig.height = 5}
make_qq_plot(data = distinct_aps_differences,
             parameter_title = "Half Width",
             parameter = Half_width_diff)
```

### Latency to Fire

```{r QQ-plot-latency, fig.width = 7, fig.height = 5}
make_qq_plot(data = distinct_aps_differences,
             parameter_title = "Latency",
             parameter = Latency_diff)
```

### Antipeak Amplitude

```{r QQ-plot-antipeak-amplitude, fig.width = 7, fig.height = 5}
make_qq_plot(data = distinct_aps_differences,
             parameter_title = "Antipeak amplitude",
             parameter = Antipeak_amplitude_diff)
```

### Time of Antipeak

```{r QQ-plot-time-of-antipeak, fig.width = 7, fig.height = 5}
make_qq_plot(data = distinct_aps_differences,
             parameter_title = "Antipeak Time",
             parameter = Antipeak_time_relative_to_threshold_diff)
```



The data did not pass normality, and a log-transformation did not work for the data (some of the data were negative, and even when I transformed it, the data were still not normal). Instead, I ran a Wilcoxon signed-rank test.

## Wilcoxon test

```{r wilcox-test}
wide_ap_df %>%
  group_by(AP_parameter_name) %>%
  wilcox_test(AP_parameter_value ~ State,
              ref.group = "Control",
              paired = T) %>%
  mutate(
    statistic = round(statistic, 2),
    p_string = pvalString(p),
    significance_stars = symnum(
      p,
      symbols   = c("***", "**", "*", ""),
      cutpoints = c(0,  .001, .01, .05, 1),
      corr      = FALSE
    )
  ) %>%
  arrange(match(AP_parameter_name, list_of_AP_parameters)) %>%
  select(c(
    AP_parameter_name,
    n1,
    n2,
    statistic,
    p_string,
    significance_stars
  )) %>%
  kable(col.names = c("Parameter", "n1", "n2", "Statistic", "p-value", ""),
        caption = "Wilcoxon Signed-Rank Test with Holm's Correction")
```


```{r test-to-see-if-it-matches-dplyr-version, eval=F}
# Testing t-test for one variable to see how it compares to t_test() from rstatix
dplyr_t_test_data <- wide_ap_df %>%
  filter(AP_parameter_name == "Antipeak_time_relative_to_threshold") %>%
  select(State, AP_parameter_name, AP_parameter_value, Letter) %>%
  pivot_wider(names_from = State,
              names_sep = "_",
              id_cols = Letter,
              values_from = AP_parameter_value) %>%
  drop_na(Insulin)


# Tue Mar 26 16:13:38 2024 ------------------------------
# The t-test values match the rstatix results


t.test(dplyr_t_test_data$Control, dplyr_t_test_data$Insulin, paired = T)

# Testing Shapiro Test for one variable to see how it compares to shapiro_test() from rstatix
wide_ap_df_differences %>%
  filter(AP_parameter_diff_name == "Latency_diff") %>%
  select(AP_parameter_diff) %>%
  pull() %>% 
  shapiro.test()

# Tue Mar 26 15:13:04 2024 ------------------------------
# The result for shapiro.test on an individual parameter matches the rstatix shapiro_test() applied over all parameters.
```

# Make AP plots

```{r make-summary-ap-frequency-plot}
full_ap_frequency_plot <- full_ap_df %>%
  group_by(State, Current_injection) %>%
  summarize(
    mean_AP_frequency = mean(AP_frequency),
    SE = sd(AP_frequency) / sqrt(n())
  ) %>%
  ggplot(
    aes(
      x = Current_injection,
      y = mean_AP_frequency,
      ymin = mean_AP_frequency - SE,
      ymax = mean_AP_frequency + SE,
      color = State,
      shape = State
    )
  ) +
  geom_pointrange(size = 1.1,
                  linewidth = 0.6,
                  position = position_dodge(width = 0)) +
  labs(x = "Current Injection (pA)",
       y = "AP Frequency (Hz)",
       color = NULL,
       shape = NULL) +
  scale_color_manual(values = c(control_group_colour, insulin_group_colour)) +
  theme(legend.position = "inside",
        legend.position.inside = c(0.15, 0.8),
        legend.key.spacing.y = unit(1.5, "lines")) +
  scale_y_continuous(expand = expansion(mult = c(0.1, .1))) +
  geom_text(
      data = t_test_current_clamp_steps,
      aes(
        x = Current_injection,
        y = max_AP_frequency + max_se + 1,
        label = significance_stars
      ),
      inherit.aes = F,
      size = 5,
      family = significance_stars_font
    )

full_ap_frequency_plot
```

```{r make-raw-ap-frequency-plot}
raw_ap_frequency_plot <- full_ap_df %>%
  ggplot(aes(x = Current_injection, y = AP_frequency, color = State)) +
  geom_point(position = "jitter") +
  labs(x = "Current Injection (pA)",
       y = "AP Frequency (Hz)",
       color = NULL) +
  scale_color_manual(values = c(control_group_colour, insulin_group_colour)) +
  theme(legend.position = "inside",
        legend.position.inside = c(0.11, 0.8)) +
  scale_y_continuous(expand = expansion(mult = c(0.1, .1)))
```

```{r make-ap-characteristics-plots}
#source(here("Scripts", "Functions.R"), local = knitr::knit_global())
peak_amplitude_plot <- make_AP_plot(data = distinct_aps,
                                    y = Peak_amplitude,
                                    y_axis_title = "Amplitude (mV)")

latency_plot <- make_AP_plot(data = distinct_aps,
                             y = Latency_to_fire,
                             y_axis_title = "Latency (ms)")

threshold_plot <- make_AP_plot(data = distinct_aps,
                               y = Threshold,
                               y_axis_title = "Threshold (mV)")

antipeak_amplitude_plot <- make_AP_plot(data = distinct_aps,
                                        y = Antipeak_amplitude,
                                        y_axis_title = "Afterhyperpolarization\nAmplitude (mV)")

time_of_antipeak_plot <- make_AP_plot(
  data = distinct_aps,
  y = Antipeak_time_relative_to_threshold,
  y_axis_title = "Time of After-\nhyperpolarization (ms)"
)

half_width_plot <- make_AP_plot(data = distinct_aps,
                                y = Half_width,
                                y_axis_title = "Half Width (ms)")


# Don't forget!! Set geom_sina_size to 3 in set-up chunk above when making presentation plots


if (save_choice == "yes") {
  save_AP_plot(full_ap_frequency_plot, "AP-frequency")
  save_AP_plot(peak_amplitude_plot, "Peak-amplitude")
  save_AP_plot(latency_plot, "Latency")
  save_AP_plot(threshold_plot, "Threshold")
  save_AP_plot(half_width_plot, "Half-width")
  save_AP_plot(antipeak_amplitude_plot, "Antipeak-amplitude")
  save_AP_plot(time_of_antipeak_plot, "Time-of-Antipeak")
}
```






## Multi-plot

\newpage


```{r AP-multiplot-figure, fig.width = 10, fig.height = 12}
#| fig.cap = "Insulin significantly decreases the excitability of DMH neurons. Data were measured under baseline conditions (\``Control\") or 25 minutes after insulin exposure (\``Insulin\"). \\emph{A)} Insulin significantly decreases action potential frequency (mean ± SE). \\emph{B)} Representative action potential traces from a current injection of 40 pA (top: control, bottom: insulin). \\emph{C)} Insulin significantly decreases action potential amplitudes. \\emph{D)} Insulin significantly decreases action potential thresholds. \\emph{E)} Insulin significantly increases the half-width of the action potential. \\emph{F)} Insulin does not significantly affect latency. \\emph{G)} Insulin does not significantly affect after-hyperpolarization amplitude. \\emph{H)} Insulin does not significantly affect after-hyperpolarization time. * = p < 0.05, ** = p < 0.01, *** = p < 0.001. \\label{ap-multiplot-figure}",
#| fig.scap = "Insulin significantly decreases the excitability of DMH neurons",
#| out.width = "100%"


full_ap_multiplot <-
  (full_ap_frequency_plot |
     (ap_trace_control / ap_trace_insulin)) / (peak_amplitude_plot + threshold_plot + half_width_plot) /
  (latency_plot + antipeak_amplitude_plot + time_of_antipeak_plot) +
  plot_layout(heights = c(0.8, 0.5, 0.5)) &
  theme(
    axis.title = element_text(size = 12, face = "plain"),
    axis.title.y = element_text(margin = margin(r = 10)),
    axis.text = element_text(size = 8),
    plot.margin = margin(10, 20, 10, 5)
  )


# Apply theme_void to just the representative traces plots since one already has a scale bar and both of them have been set to the same y-axes

full_ap_multiplot[[1]][[2]][[1]] <- full_ap_multiplot[[1]][[2]][[1]] + theme_void()
full_ap_multiplot[[1]][[2]][[2]] <- full_ap_multiplot[[1]][[2]][[2]] + theme_void()


# Manually applied a list of labels because I wanted the second trace to be blank
# Control and insulin sweeps both count as figure "B"
# Styled tags separately since theme_void on plots "B" and "[c]" changed the style

full_ap_multiplot +
  plot_annotation(tag_levels = list(c('A','B','','C','D','E','F','G','H'))) &
  theme(
    plot.tag = element_text(
      size = 18,
      margin = margin(r = 10, b = 10),
      face = "bold"
    )
  )
```

## Individual Plots {.tabset}

### Mean AP Frequency Plots

```{r show-full-ap-frequency-plot, fig.width = 7, fig.height = 5}
full_ap_frequency_plot
```

### Raw AP Frequency Plot

```{r show-raw-ap-frequency-plot, fig.width = 7, fig.height = 5}
raw_ap_frequency_plot
```


### Peak Amplitude

```{r show-peak-amplitude, fig.width = 7, fig.height = 5}
peak_amplitude_plot
```

### Threshold

```{r show-threshold, fig.width = 7, fig.height = 5}
threshold_plot
```

### Half-Width
```{r show-half-width, fig.width = 7, fig.height = 5}
half_width_plot
```


### Latency to Fire

```{r show-latency, fig.width = 7, fig.height = 5}
latency_plot
```

### Antipeak Amplitude

```{r show-antipeak, fig.width = 7, fig.height = 5}
antipeak_amplitude_plot
```

### Time of Antipeak

```{r show-time-of-antipeak, fig.width = 7, fig.height = 5}
time_of_antipeak_plot
```



```{r exit-knitting}
knitr::knit_exit()
```

